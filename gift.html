<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚®ãƒ•ãƒˆå—å–</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    
    <style>
        body { font-family: sans-serif; background-color: #ffeaa7; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h1 { color: #e17055; }
        .gift-icon { font-size: 4rem; margin-bottom: 10px; }
        button { background-color: #e17055; color: white; border: none; padding: 15px; width: 100%; border-radius: 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        button:disabled { background-color: #ccc; }
        .message { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div id="app" class="card">
    <div class="gift-icon">ğŸ</div>
    <h1>ã‚®ãƒ•ãƒˆã‚’å—ã‘å–ã‚‹</h1>

    <div v-if="!giftCode">
        <p>ç„¡åŠ¹ãªã‚®ãƒ•ãƒˆURLã§ã™ã€‚<br>QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿ç›´ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <div v-else>
        <p v-if="!isConnected">
            ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶šã—ã¦<br>ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å—ã‘å–ã‚Šã¾ã—ã‚‡ã†ã€‚
        </p>
        
        <div v-if="!isConnected">
            <button @click="connectWallet">MetaMaskã‚’æ¥ç¶š</button>
        </div>

        <div v-else>
            <p>æ¥ç¶šä¸­: {{ shortAddress }}</p>
            <div v-if="!hasAgreed" style="background:#fff0f0; padding:10px; border-radius:5px; margin-bottom:10px;">
                <p style="color:red; font-size:0.9rem; margin:0;">
                    â€»æœªç™»éŒ²ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ã€‚
                </p>
                <a href="terms.html" target="_blank" style="font-size:0.9rem; color:#00a8ff;">åˆ©ç”¨è¦ç´„</a>ã‚’ç¢ºèªã®ä¸Šã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
            </div>
            <button @click="claimGift" :disabled="isLoading">
                {{ isLoading ? 'å‡¦ç†ä¸­...' : (hasAgreed ? 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹' : 'è¦ç´„ã«åŒæ„ã—ã¦å—ã‘å–ã‚‹') }}
            </button>
        </div>

        <p class="message" :style="{color: isError ? 'red' : 'green'}">{{ statusMessage }}</p>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // â˜…ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹
            const CONTRACT_ADDRESS = "0xYOUR_CONTRACT_ADDRESS";

            const ABI = [
                "function claimGift(string) external",
                "function hasAgreedToTerms(address) view returns (bool)",
                "function acceptTerms() external"
            ];

            const giftCode = ref("");
            const walletAddress = ref("");
            const isConnected = ref(false);
            const hasAgreed = ref(false);
            const isLoading = ref(false);
            const statusMessage = ref("");
            const isError = ref(false);

            const shortAddress = computed(() => walletAddress.value.slice(0,6) + "..." + walletAddress.value.slice(-4));

            onMounted(() => {
                const params = new URLSearchParams(window.location.search);
                giftCode.value = params.get("code");
            });

            const connectWallet = async () => {
                if (!window.ethereum) return alert("MetaMaskç­‰ãŒå¿…è¦ã§ã™");
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    walletAddress.value = await signer.getAddress();
                    
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                    hasAgreed.value = await contract.hasAgreedToTerms(walletAddress.value);
                    
                    isConnected.value = true;
                } catch (e) {
                    console.error(e);
                }
            };

            const claimGift = async () => {
                isLoading.value = true;
                statusMessage.value = "";
                isError.value = false;

                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                    if (!hasAgreed.value) {
                        const txAgree = await contract.acceptTerms();
                        statusMessage.value = "è¦ç´„ã«åŒæ„ä¸­...";
                        await txAgree.wait();
                        hasAgreed.value = true;
                    }

                    const tx = await contract.claimGift(giftCode.value);
                    statusMessage.value = "ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã«æ›¸ãè¾¼ã¿ä¸­...";
                    await tx.wait();

                    statusMessage.value = "ğŸ‰ å—å–å®Œäº†ï¼ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                    isError.value = false;
                } catch (e) {
                    console.error(e);
                    isError.value = true;
                    if (e.message.includes("Invalid gift")) {
                        statusMessage.value = "ã“ã®ã‚®ãƒ•ãƒˆã¯æ—¢ã«å—ã‘å–ã‚‰ã‚Œã¦ã„ã‚‹ã‹ã€ç„¡åŠ¹ã§ã™ã€‚";
                    } else {
                        statusMessage.value = "ã‚¨ãƒ©ãƒ¼: " + (e.reason || "å—å–ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    }
                } finally {
                    isLoading.value = false;
                }
            };

            return { giftCode, connectWallet, claimGift, isConnected, hasAgreed, shortAddress, isLoading, statusMessage, isError };
        }
    }).mount('#app');
</script>
</body>
</html>