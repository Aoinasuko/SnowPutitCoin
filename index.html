<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›ªãƒ—ãƒã‚³ã‚¤ãƒ³ç®¡ç†ï¼†ã‚®ãƒ•ãƒˆä½œæˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f0f8ff; color: #333; padding: 20px; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 700px; margin: 0 auto; }
        h1, h2, h3 { color: #00a8ff; text-align: center; }
        button { background-color: #00a8ff; color: white; border: none; padding: 12px; width: 100%; margin-top: 10px; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 1rem; transition: 0.3s; }
        button:hover { background-color: #008ecc; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        input[type="number"], input[type="text"] { width: 100%; padding: 12px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; }
        input[type="file"] { margin-top: 10px; }
        .admin-zone { background: #fff0f0; padding: 20px; border-radius: 8px; margin-top: 30px; border: 1px solid #ffcccc;}
        .user-gift-zone { background: #e0f7fa; padding: 20px; border-radius: 8px; margin-top: 30px; border: 1px solid #b2ebf2;}
        .design-zone { background: #fdf6e3; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #eee8d5; text-align: center; }
        .metamask-zone { background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffe0b2; text-align: center; }
        .test-btn { background-color: #00b894; }
        .test-btn:hover { background-color: #00cec9; }
        .gift-preview-area { margin-top: 20px; text-align: center; border-top: 2px dashed #ddd; padding-top: 20px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .generated-image { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-bottom: 15px; border: 1px solid #eee; }
        .download-btn { background-color: #6c5ce7; }
        .download-btn:hover { background-color: #5b4cc4; }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; color: white; margin-bottom: 10px;}
        .badge-on { background-color: #2ecc71; }
        .badge-off { background-color: #95a5a6; }
        #qrcode-container { display: none; }
        .uri-display { font-size: 0.8rem; color: #666; word-break: break-all; background: #fff; padding: 5px; border-radius: 4px; margin-top: 5px; }
    </style>
</head>
<body>

<div id="app" class="container">
    <h1>â„ï¸ é›ªãƒ—ãƒã‚³ã‚¤ãƒ³ (YKPUTI) â„ï¸</h1>
    
    <div v-if="!isConnected">
        <button @click="connectWallet">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶š</button>
    </div>
    <div v-else>
        <p style="text-align:center">æ¥ç¶šä¸­: {{ shortAddress }}</p>
        <p style="text-align:center">
             ç™ºè¡ŒçŠ¶æ³: 
            <span :class="['status-badge', isMintingOpen ? 'badge-on' : 'badge-off']">
                {{ isMintingOpen ? 'ç™ºè¡Œå¯èƒ½' : 'åœæ­¢ä¸­' }}
            </span>
        </p>
        <p style="text-align:center">æ®‹é«˜: <strong>{{ userBalance }} YKPUTI</strong></p>

        <div v-if="!hasAgreed">
            <div class="terms-box">
                <p><strong>åˆ©ç”¨è¦ç´„ã¸ã®åŒæ„ãŒå¿…è¦ã§ã™</strong><br>
                æœ¬ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹å‰ã«ã€å¿…ãšåˆ©ç”¨è¦ç´„ã‚’ã”ç¢ºèªãã ã•ã„ã€‚<br>
                æœ¬ãƒˆãƒ¼ã‚¯ãƒ³ã¯é‡‘éŠ­çš„ä¾¡å€¤ã‚’æŒãŸãšã€å£²è²·ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                <p style="text-align:center; margin-top:15px;">
                    <a href="terms.html" target="_blank" style="color:#00a8ff; font-weight:bold; text-decoration:underline;">
                        ğŸ“„ åˆ©ç”¨è¦ç´„å…¨æ–‡ã‚’èª­ã‚€
                    </a>
                </p>
            </div>
            <p style="font-size:0.8rem; color:#666; text-align:center;">
                ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã“ã¨ã§ã€ä¸Šè¨˜è¦ç´„ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã•ã‚Œã¾ã™ã€‚
            </p>
            <button @click="signAgreement" :disabled="isLoading">è¦ç´„ã«åŒæ„ã—ã¦åˆ©ç”¨é–‹å§‹</button>
        </div>

        <div class="metamask-zone">
            <h3 style="color:#f39c12; margin-top:0;">é›ªãƒ—ãƒã‚³ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
            <p style="font-size:0.9rem;">
                é›ªãƒ—ãƒã‚³ã‚¤ãƒ³ã‚’ã‚¦ã‚©ãƒ¬ãƒƒãƒˆä¸€è¦§ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã€ã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
            </p>
            <button @click="addToMetaMask" style="background-color:#f39c12;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹</button>
        </div>

        <div class="design-zone">
            <h3>ğŸ¨ ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š</h3>
            <p style="font-size:0.9rem;">å¥½ããªç”»åƒã‚’èƒŒæ™¯ã«è¨­å®šã§ãã¾ã™ (æ¨ªé•·æ¨å¥¨)</p>
            <input type="file" accept="image/*" @change="handleFileUpload">
            <p v-if="uploadedImageSrc" style="color:green; font-size:0.8rem;">âœ” ç”»åƒãŒã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ</p>
        </div>

        <div v-if="!isOwner">
            <h2>è‡ªåˆ†ç”¨ã«ç™ºè¡Œ (Mint)</h2>
            <div v-if="isMintingOpen">
                <p>1å›ã«ã¤ãæœ€å¤§100æšã¾ã§ç™ºè¡Œã§ãã¾ã™ã€‚</p>
                <input type="number" v-model="userMintAmount" placeholder="æšæ•° (1ã€œ100)" min="1" max="100">
                <button @click="mintToken" :disabled="!userMintAmount || isLoading">ç™ºè¡Œã™ã‚‹</button>
            </div>
            <div v-else>
                <p style="text-align:center; color:#888;">ç¾åœ¨ã€é‹å–¶ã«ã‚ˆã‚Šç™ºè¡ŒãŒåœæ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
            </div>

            <div class="user-gift-zone">
                <h3 style="color:#0097e6">ğŸ ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰ã‚’ä½œã‚‹</h3>
                <div v-if="isMintingOpen">
                    <input type="number" v-model="giftAmount" placeholder="ã‚®ãƒ•ãƒˆã«ã™ã‚‹æšæ•° (1ã€œ100)" min="1" max="100">
                    <button @click="createGift" :disabled="isLoading || !giftAmount" style="background-color: #e17055;">
                        {{ isLoading ? 'å‡¦ç†ä¸­...' : 'ã‚®ãƒ•ãƒˆä½œæˆï¼†ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ' }}
                    </button>
                </div>
                <div v-else>
                    <p style="text-align:center; color:#888;">ç™ºè¡Œåœæ­¢ä¸­ã®ãŸã‚ä½œæˆã§ãã¾ã›ã‚“ã€‚</p>
                </div>
                <hr style="margin: 15px 0; border-top:1px dashed #b2ebf2; border-bottom:0;">
                <input type="number" v-model="testAmount" placeholder="è¡¨ç¤ºãƒ†ã‚¹ãƒˆæšæ•°">
                <button @click="testGenerate" class="test-btn" :disabled="!testAmount">ãƒ†ã‚¹ãƒˆç”»åƒã‚’ç”Ÿæˆ</button>
            </div>
        </div>

        <div v-if="isOwner" class="admin-zone">
            <h3 style="color:#d63031">ğŸ‘‘ ç®¡ç†è€…ãƒ‘ãƒãƒ«</h3>
            
            <p><strong>âš™ï¸ ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±è¨­å®š (Pinata)</strong></p>
            <input type="text" v-model="newMetadataURI" placeholder="ä¾‹: ipfs://QmJsonYYYYYY...">
            <div v-if="currentMetadataURI" class="uri-display">ç¾åœ¨è¨­å®šä¸­: {{ currentMetadataURI }}</div>
            <button @click="setMetadata" :disabled="isLoading || !newMetadataURI" style="background-color: #d63031;">URIã‚’ä¿å­˜ã™ã‚‹</button>
            
            <hr style="margin: 20px 0; border:0; border-top:1px solid #ffcccc;">

            <p><strong>1. è‡ªåˆ†ç”¨ã«ç™ºè¡Œ (ç„¡åˆ¶é™)</strong></p>
            <div style="display:flex; gap:10px;">
                <input type="number" v-model="adminMintAmount" placeholder="æšæ•°">
                <button @click="adminMint" :disabled="isLoading || !adminMintAmount" style="width:auto; margin-top:0;">ç™ºè¡Œ</button>
            </div>
            
            <p><strong>2. è¨­å®šå¤‰æ›´</strong></p>
            <button v-if="!isMintingOpen" @click="toggleMinting(true)" :disabled="isLoading">ç™ºè¡Œã‚’é–‹æ”¾ã™ã‚‹ (ON)</button>
            <button v-else @click="toggleMinting(false)" style="background-color:#ff6b6b;" :disabled="isLoading">ç™ºè¡Œã‚’åœæ­¢ã™ã‚‹ (OFF)</button>

            <hr style="margin: 20px 0; border:0; border-top:1px solid #ffcccc;">

            <p><strong>3. ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰ä½œæˆ (ç„¡åˆ¶é™)</strong></p>
            <input type="number" v-model="giftAmount" placeholder="ã‚®ãƒ•ãƒˆæšæ•°">
            <button @click="createGift" :disabled="isLoading || !giftAmount" style="background-color: #e17055;">
                {{ isLoading ? 'å‡¦ç†ä¸­...' : 'ã‚®ãƒ•ãƒˆä½œæˆï¼†ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ' }}
            </button>

            <p><strong>4. ãƒ‡ã‚¶ã‚¤ãƒ³ç¢ºèªç”¨</strong></p>
            <input type="number" v-model="testAmount" placeholder="ãƒ†ã‚¹ãƒˆæšæ•°">
            <button @click="testGenerate" class="test-btn" :disabled="!testAmount">ãƒ†ã‚¹ãƒˆç”»åƒã‚’ç”Ÿæˆ</button>
        </div>

        <div v-if="cardImageUrl" class="gift-preview-area">
            <p>â–¼ ç”Ÿæˆã•ã‚ŒãŸã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰ ({{ isTestMode ? 'TEST' : 'LIVE' }})</p>
            <img :src="cardImageUrl" class="generated-image" alt="Gift Card Preview">
            <a :href="cardImageUrl" :download="isTestMode ? 'giftcard_test.png' : 'giftcard.png'" style="text-decoration:none;">
                <button class="download-btn">ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (PNG)</button>
            </a>
            <p v-if="!isTestMode" style="font-size:0.8rem; margin-top:10px; color:#666;">
                URL: <a :href="generatedGiftUrl" target="_blank">{{ generatedGiftUrl }}</a>
            </p>
        </div>

        <p style="color:red; text-align:center;">{{ errorMessage }}</p>
        <p style="color:#00a8ff; font-weight:bold; text-align:center;">{{ successMessage }}</p>
    </div>
    <div id="qrcode-container"></div>
</div>

<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            // ============================================
            // â˜…è¨­å®š: ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹
            // ============================================
            const CONTRACT_ADDRESS = "0x8515eedfD088A4e91768269133abd251A3fE64d0";
            
            // å—å–ãƒšãƒ¼ã‚¸ã®URLè‡ªå‹•å–å¾— (index.html ã¨åŒã˜å ´æ‰€ã® gift.html)
            const BASE_GIFT_URL = window.location.href.replace('index.html', '') + "gift.html";

            // ABIå®šç¾©
            const ABI = [
                "function isMintingEnabled() view returns (bool)",
                "function mint(uint256 amount) external", 
                "function adminMint(uint256) external",
                "function createGift(bytes32, uint256) external",
                "function toggleMinting(bool) external",
                "function owner() view returns (address)",
                "function balanceOf(address) view returns (uint256)",
                "function decimals() view returns (uint8)",
                "function totalLifetimeSupply() view returns (uint256)",
                "function contractMetadataURI() view returns (string)",
                "function setContractMetadataURI(string) external",
                "function hasAgreedToTerms(address) view returns (bool)", // è¿½åŠ 
                "function acceptTerms() external" // è¿½åŠ 
            ];

            // ã‚¹ãƒ†ãƒ¼ãƒˆå¤‰æ•°
            const walletAddress = ref("");
            const isConnected = ref(false);
            const isOwner = ref(false);
            const isMintingOpen = ref(false);
            const hasAgreed = ref(false); // è¦ç´„åŒæ„ãƒ•ãƒ©ã‚°
            const userBalance = ref("0");
            
            const userMintAmount = ref("");
            const adminMintAmount = ref("");
            const giftAmount = ref("");
            const testAmount = ref("10");
            
            const newMetadataURI = ref("");
            const currentMetadataURI = ref("");

            const generatedGiftUrl = ref("");
            const cardImageUrl = ref("");
            const isTestMode = ref(false);
            const uploadedImageSrc = ref("");
            
            const isLoading = ref(false);
            const errorMessage = ref("");
            const successMessage = ref("");

            const shortAddress = computed(() => walletAddress.value ? walletAddress.value.slice(0,6) + "..." + walletAddress.value.slice(-4) : "");

            // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶š
            const connectWallet = async () => {
                errorMessage.value = "";
                if (!window.ethereum) return errorMessage.value = "MetaMaskãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“";
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    walletAddress.value = await signer.getAddress();
                    isConnected.value = true;
                    await refreshData(signer);
                } catch (e) { errorMessage.value = e.message; }
            };

            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            const refreshData = async (signer) => {
                try {
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                    isMintingOpen.value = await contract.isMintingEnabled();
                    const ownerAddr = await contract.owner();
                    isOwner.value = (ownerAddr.toLowerCase() === walletAddress.value.toLowerCase());
                    const bal = await contract.balanceOf(walletAddress.value);
                    const dec = await contract.decimals();
                    userBalance.value = ethers.formatUnits(bal, dec);
                    hasAgreed.value = await contract.hasAgreedToTerms(walletAddress.value);
                    currentMetadataURI.value = await contract.contractMetadataURI();
                } catch (e) { console.error(e); }
            };

            // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { uploadedImageSrc.value = e.target.result; };
                reader.readAsDataURL(file);
            };

            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å…±é€šå‡¦ç†
            const sendTx = async (action, msg) => {
                isLoading.value = true; errorMessage.value = ""; successMessage.value = "";
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                    
                    // decimalsãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹ãŸã‚å–å¾—ã—ã¦ãŠã
                    let decimals = 18;
                    try { decimals = await contract.decimals(); } catch(e){}

                    const tx = await action(contract, decimals);
                    await tx.wait();
                    successMessage.value = msg;
                    await refreshData(signer);
                } catch (e) {
                    console.error(e);
                    if (e.code === 'ACTION_REJECTED') {
                        errorMessage.value = "MetaMaskã§æ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚";
                    } else if (e.message && e.message.includes("insufficient funds")) {
                        errorMessage.value = "ã‚¬ã‚¹ä»£(ETH)ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚";
                    } else {
                        errorMessage.value = "ã‚¨ãƒ©ãƒ¼: " + (e.reason || e.message);
                    }
                } finally {
                    isLoading.value = false;
                }
            };

            // â˜…è¦ç´„åŒæ„å‡¦ç†
            const signAgreement = async () => {
                await sendTx(async (c) => await c.acceptTerms(), "è¦ç´„ã«åŒæ„ã—ã¾ã—ãŸï¼");
            };

            // ç™ºè¡ŒON/OFF
            const toggleMinting = async (status) => {
                await sendTx(async (c) => await c.toggleMinting(status), "è¨­å®šã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
            };

            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¨­å®š
            const setMetadata = async () => {
                await sendTx(async (c) => await c.setContractMetadataURI(newMetadataURI.value), "ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿URIã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
                newMetadataURI.value = ""; 
            };

            // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¡Œ
            const mintToken = async () => {
                if(userMintAmount.value > 100) return alert("1å›ã«ã¤ã100æšã¾ã§ã§ã™");
                await sendTx(async (c, decimals) => {
                    const amt = ethers.parseUnits(userMintAmount.value.toString(), decimals);
                    return await c.mint(amt);
                }, `${userMintAmount.value}æš ç™ºè¡Œã—ã¾ã—ãŸï¼`);
            };

            // ç®¡ç†è€…ç™ºè¡Œ
            const adminMint = async () => {
                await sendTx(async (c, decimals) => {
                    const amt = ethers.parseUnits(adminMintAmount.value, decimals);
                    return await c.adminMint(amt);
                }, "ç™ºè¡Œã—ã¾ã—ãŸ");
            };

            const createGift = async () => {
                if (!isOwner.value && giftAmount.value > 100) return alert("1å›ã«ã¤ã100æšã¾ã§ã§ã™");

                isTestMode.value = false;
                cardImageUrl.value = "";
                const giftId = "gift-" + Date.now() + "-" + Math.floor(Math.random() * 10000);
                const amount = parseInt(giftAmount.value);

                await sendTx(async (c, decimals) => {
                    const amtWei = ethers.parseUnits(giftAmount.value.toString(), decimals);
                    const hash = ethers.solidityPackedKeccak256(["string"], [giftId]);
                    return await c.createGift(hash, amtWei);
                }, "ã‚®ãƒ•ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼ç”»åƒã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...");

                const provider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
                const currentTotal = await contract.totalLifetimeSupply();
                
                const endSerial = Number(currentTotal);
                const startSerial = endSerial - amount + 1;

                const url = `${BASE_GIFT_URL}?code=${giftId}`;
                generatedGiftUrl.value = url;

                const qrContainer = document.getElementById("qrcode-container");
                qrContainer.innerHTML = "";
                new QRCode(qrContainer, { text: url, width: 200, height: 200, correctLevel : QRCode.CorrectLevel.H });

                setTimeout(() => {
                    // â˜…å¤‰æ›´ç‚¹: giftId ã‚’æ¸¡ã™
                    generateCardImage(giftAmount.value, startSerial, endSerial, giftId);
                }, 500);
            };

            const testGenerate = () => {
                isTestMode.value = true;
                cardImageUrl.value = "";
                errorMessage.value = "";
                successMessage.value = "ãƒ†ã‚¹ãƒˆç”»åƒã‚’ç”Ÿæˆã—ã¾ã—ãŸ";

                const dummyId = "TEST-ID-" + Math.floor(Math.random() * 1000);
                const dummyUrl = `${BASE_GIFT_URL}?code=${dummyId}`;
                generatedGiftUrl.value = dummyUrl;

                const qrContainer = document.getElementById("qrcode-container");
                qrContainer.innerHTML = "";
                new QRCode(qrContainer, { text: dummyUrl, width: 200, height: 200, correctLevel : QRCode.CorrectLevel.H });

                setTimeout(() => {
                    const startSerial = 8801;
                    const endSerial = 8800 + parseInt(testAmount.value);
                    // â˜…å¤‰æ›´ç‚¹: dummyId ã‚’æ¸¡ã™
                    generateCardImage(testAmount.value, startSerial, endSerial, dummyId);
                }, 300);
            };

            // â˜…å¤‰æ›´ç‚¹: å¼•æ•°ã« giftId ã‚’è¿½åŠ 
            // ---------------------------------------------------------
            // ä¿®æ­£ç®‡æ‰€ 1: canvas ã‚’å¼•æ•°ã¨ã—ã¦æ¸¡ã™ã‚ˆã†ã«å¤‰æ›´
            // ---------------------------------------------------------
            const generateCardImage = (amount, startSerial, endSerial, giftId = "") => {
                const canvas = document.createElement('canvas');
                const width = 800;
                const height = 480;
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                const bgImg = new Image();
                bgImg.crossOrigin = "Anonymous";

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å…ˆã«å®šç¾©
                bgImg.onload = () => {
                    drawCanvasContent(canvas, ctx, bgImg, width, height, amount, startSerial, endSerial, giftId);
                };

                // ã‚¨ãƒ©ãƒ¼æ™‚ï¼ˆCardBase.pngãŒç„¡ã„å ´åˆãªã©ï¼‰ã¯nullã‚’æ¸¡ã—ã¦ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æç”»ã¸
                bgImg.onerror = () => {
                    drawCanvasContent(canvas, ctx, null, width, height, amount, startSerial, endSerial, giftId);
                };

                // ã‚½ãƒ¼ã‚¹ã®åˆ†å²
                if (uploadedImageSrc.value) {
                    bgImg.src = uploadedImageSrc.value;
                } else {
                    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚’èª­ã¿è¾¼ã‚€
                    bgImg.src = "./CardBase.png";
                }
            };

            // ---------------------------------------------------------
            // ä¿®æ­£ç®‡æ‰€ 2: å¼•æ•°ã§ canvas ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«å¤‰æ›´
            // ---------------------------------------------------------
            const drawCanvasContent = (canvas, ctx, bgImg, w, h, amount, startSerial, endSerial, giftId) => {
                if (bgImg) {
                    ctx.drawImage(bgImg, 0, 0, w, h);
                } else {
                    ctx.drawImage(bgImg, 0, 0, w, h);
                }

                if (isTestMode.value) {
                    ctx.save();
                    ctx.translate(w/2, h/2);
                    ctx.rotate(-Math.PI / 6);
                    ctx.font = "bold 150px Helvetica";
                    ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
                    ctx.textAlign = "center";
                    ctx.fillText("SAMPLE", 0, 0);
                    ctx.restore();
                }

                ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
                ctx.shadowColor = "rgba(0, 0, 0, 0.1)";
                ctx.shadowBlur = 10;
                ctx.fillRect(520, 40, 240, 400);
                ctx.shadowBlur = 0;

                ctx.fillStyle = "#333";
                ctx.textAlign = "left";
                
                ctx.font = "bold 30px Helvetica";
                ctx.fillStyle = "#666";
                ctx.fillText("é›ªãƒ—ãƒã‚³ã‚¤ãƒ³", 70, 100);

                ctx.fillStyle = "#00a8ff";
                ctx.font = "bold 100px Helvetica";
                ctx.fillText(amount, 70, 250);
                
                ctx.font = "bold 40px Helvetica";
                ctx.fillStyle = "#333";
                ctx.fillText("YKPUTI", 70 + (amount.toString().length * 60) + 10, 250);

                const pad = (n) => n.toString().padStart(4, '0');
                const serialText = `Serial: #${pad(startSerial)} - #${pad(endSerial)}`;
                ctx.font = "bold 18px Helvetica";
                ctx.fillStyle = "#555";
                ctx.textAlign = "right"; 
                ctx.fillText(serialText, 480, 420);

                ctx.textAlign = "left"; 
                ctx.font = "20px Helvetica";
                ctx.fillStyle = "#555";
                ctx.fillText("é›ªãƒ—ãƒã®ã‚®ãƒ•ãƒˆã‚’ã‚ãªãŸã«ï¼", 70, 320); 

                const qrContainer = document.getElementById("qrcode-container");
                const qrImgElement = qrContainer.querySelector("img");
                if (qrImgElement) {
                    ctx.drawImage(qrImgElement, 540, 140, 200, 200);
                }

                // ã‚®ãƒ•ãƒˆIDå°å­—
                if (giftId) {
                    ctx.font = "12px Courier New";
                    ctx.fillStyle = "#666";
                    ctx.textAlign = "center";
                    ctx.fillText("ID: " + giftId, 640, 380);
                }

                // â˜…ã“ã“ã§ canvas ã‚’ä½¿ã†ãŸã‚ã€å¼•æ•°ã§å—ã‘å–ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸ
                cardImageUrl.value = canvas.toDataURL("image/png");
            };

            // â˜…MetaMaskã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
            const addToMetaMask = async () => {

                try {
                    // ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’é€šã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                    await window.ethereum.request({
                        method: 'wallet_watchAsset',
                        params: {
                            type: 'ERC20',
                            options: {
                                address: CONTRACT_ADDRESS,
                                symbol: 'YKPUTI',
                                decimals: 18,
                                image: 'https://black-holy-cod-224.mypinata.cloud/ipfs/bafybeigtecms2jewnu3t6hbej6yxyqitc6lcoxics4izubmjqebcsv6v6q',
                            },
                        },
                    });
                    successMessage.value = "ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã—ãŸï¼";
                } catch (error) {
                    console.error(error);
                    errorMessage.value = "ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message;
                }
            };

            return { 
                connectWallet, 
                signAgreement, 
                mintToken, 
                adminMint, 
                createGift, 
                testGenerate, 
                toggleMinting, 
                setMetadata, 
                handleFileUpload, 
                addToMetaMask,
                isConnected, 
                isOwner, 
                isMintingOpen, 
                hasAgreed,
                userBalance, 
                userMintAmount, 
                adminMintAmount, 
                giftAmount, 
                testAmount, 
                newMetadataURI, 
                currentMetadataURI, 
                generatedGiftUrl, 
                cardImageUrl, 
                isTestMode, 
                uploadedImageSrc, 
                isLoading, 
                errorMessage, 
                successMessage, 
                shortAddress 
            };
        }
    }).mount('#app');
</script>
</body>
</html>